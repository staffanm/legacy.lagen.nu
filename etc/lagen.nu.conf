# All the apache configuration required for lagen.nu (mostly mod_rewrite magic)

# dont miss <directory> below!
DocumentRoot /www/staffan/lagen.nu/data

<Directory /www/staffan/lagen.nu>
    Order allow,deny
    Allow from all
</Directory>
#Alias /css /cygdrive/c/Users/staffan/wds/lagen.nu/css
#Alias /img /cygdrive/c/Users/staffan/wds/lagen.nu/img
#Alias /js  /cygdrive/c/Users/staffan/wds/lagen.nu/js
#ServerName localhost

RewriteMap old_dv txt:/www/staffan/lagen.nu/etc/old-dv-ids.map
RewriteMap dv txt:/www/staffan/lagen.nu/data/dv/generated/uri.map
#LoadModule include_module modules/mod_include.so
#mod_rewrite:s logs are worse than useless...
#RewriteLog logs/lagen.nu-rewrite_log
#RewriteLogLevel 2

<Directory /www/staffan/lagen.nu/data>
    Options +Indexes +Includes

    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml

    # old RSS feed redirect to the appropriate new shiny Atom feed
    Redirect /nyheter/site.rss https://lagen.nu/nyheter/site.atom
    Redirect /nyheter/nya-lagar.rss https://lagen.nu/nyheter/lagar.atom
    Redirect /nyheter/nya-forordningar.rss https://lagen.nu/nyheter/forordningar.atom
    Redirect /nyheter/andrade-lagar.rss https://lagen.nu/nyheter/lagar.atom
    Redirect /nyheter/andrade-forordningar.rss https://lagen.nu/nyheter/forordningar.atom
    Redirect /nyheter/hd-domar.rss https://lagen.nu/dom/nyheter/allmanna.atom
    Redirect /nyheter/regering-och-hovrattsdomar.rss https://lagen.nu/dom/nyheter/forvaltning.atom
    Redirect /nyheter/ovriga-domar.rss https://lagen.nu/dom/nyheter/ad.atom

    RewriteEngine On
    RewriteBase /
      
    # Does the URI contain a space ?
    RewriteCond %{REQUEST_URI} ^(.*)\ (.*)$
    # Yes, then replace it with an underscore
    RewriteRule ^.*$ %1_%2 [R=301,L]

    # To map requested (UTF-8 encoded) URLs to local file system
    # (which cygwin apache seems to treat as latin-1-encoded...) --
    # not pretty but it sort of works.
    RewriteRule (.*?)Ã¥(.*) /$1å$2
    RewriteRule (.*?)Ã¤(.*) /$1ä$2
    RewriteRule (.*?)Ã¶(.*) /$1ö$2


    # site
    RewriteRule   ^om/(.*)$      /site/generated/om/$1                 [L]
    RewriteRule   ^nyheter$            /nyheter/                       [R=301,L]
    RewriteRule   ^nyheter/$ /site/generated/nyheter/                  [L]
    RewriteRule   ^nyheter/site(.*)$ /site/generated/nyheter/site$1    [L]
    RewriteRule   ^nyheter/(\d+-\d+-\d+.*)$ /site/generated/nyheter/$1 [L]

    # DV
    # specialcasing for index pages
    RewriteRule ^dom/index$          /dom/index/             [R=301,L]
    RewriteRule ^dom/index/(.*)      /dv/generated/index/$1  [L]
    # specialcasing for news pages
    RewriteRule ^dom/nyheter$          /dom/news/            [R=301,L]
    RewriteRule ^dom/nyheter/(.*)      /dv/generated/news/$1 [L]
    # check if we need to translate from ancient URIs to some slightly newer
    RewriteRule ^dom/([0-9]*/[0-9]*) /dom/${old_dv:$1}       [R=301,L]
    # check if we need to translate uripart->basefile (eg ra/1996:36->REG/12435-95_1)
    RewriteCond %{REQUEST_URI}      ^/dom/(.*)$
    # RewriteRule ^dom/(.*)$ foobar.html
    RewriteCond ${dv:%1}             ^.+$              
    RewriteRule ^dom/(.*)$    	     /dv/generated/${dv:$1}.html
    RewriteRule ^dom/(.*).xht2$      /dv/parsed/${dv:$1}.xht2            [L]
    RewriteRule ^dom/(.*).htm$       /dv/intermediate/html/${dv:$1}.html [L]
    # otherwise just a simple rewrite to the physical file
    RewriteRule ^dom/(.*)$           /dv/generated/$1.html               [L]

    # SFS 
    # first, check to see if the file is nonexistant
    RewriteCond %{REQUEST_URI} (\d+):(.+)
    RewriteCond /www/staffan/lagen.nu/data/sfs/generated/%1/%2.html !-f
    RewriteRule ^(\d+):(.+)$       /sfs/generated/notfound.shtml [L,E=SFS:$1:$2]


    RewriteRule ^blendow.sfs.zip$  /sfs/blendow.sfs.zip        [L]
    RewriteRule ^(\d+):(.*).xht2$  /sfs/parsed/$1/$2.xht2      [L]
    RewriteRule ^(\d+):(.*).txt$   /sfs/intermediate/$1/$2.txt [L]
    RewriteRule ^(\d+):(.+)$       /sfs/generated/$1/$2.html   [L]

    RewriteRule ^index$            /index/       [R=301,L]
    RewriteRule ^index/(.*)$       /sfs/generated/index/$1     [L]
    RewriteRule ^nyheter/(.*)$     /sfs/generated/news/$1     [L]
    

    # final rule - everything that hasn't matched so far (my attempts
    # to do a more general rule gave an infinite rewriting loop)
    RewriteRule   ^$             /site/generated/           [L]
    RewriteRule   ^css/(.*)$     /site/generated/css/$1     [L]
    RewriteRule   ^img/(.*)$     /site/generated/img/$1     [L]
    RewriteRule   ^js/(.*)$      /site/generated/js/$1      [L]


    # Send application/xhtml+xml to browsers that (really) supports it
    # RewriteCond %{HTTP_ACCEPT} application/xhtml\+xml
    # RewriteCond %{HTTP_ACCEPT} !application/xhtml\+xml\s*;\s*q=0
    # RewriteCond %{REQUEST_FILENAME} \.html$
    # RewriteCond %{THE_REQUEST} HTTP/1\.1
    # RewriteRule .* - [T=application/xhtml+xml]
    
    AddDefaultCharset utf-8 
    AddType application/rss+xml .rss
    AddType application/atom+xml .atom
</Directory>
