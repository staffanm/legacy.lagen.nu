# All the apache configuration required for lagen.nu (mostly mod_rewrite magic)

LogLevel debug
ServerAdmin staffan@tomtebo.org
DocumentRoot /cygdrive/c/Users/staffan/wds/ferenda.lagen.nu/data
Alias /css /cygdrive/c/Users/staffan/wds/ferenda.lagen.nu/css
Alias /img /cygdrive/c/Users/staffan/wds/ferenda.lagen.nu/img
Alias /js  /cygdrive/c/Users/staffan/wds/ferenda.lagen.nu/js
ServerName localhost
<Directory /cygdrive/c/Users/staffan/wds/ferenda.lagen.nu>
Order allow,deny
Allow from all
</Directory>
  
RewriteMap old_dv txt:old-dv.map
RewriteMap dv txt:/cygdrive/c/Users/staffan/wds/ferenda.lagen.nu/data/dv/generated/uri.map
<Directory /cygdrive/c/Users/staffan/wds/ferenda.lagen.nu/data>
    Order allow,deny
    Allow from all

    RewriteEngine On
    RewriteBase /
      
    # Does the URI contain a space ?
    RewriteCond %{REQUEST_URI} ^(.*)\ (.*)$
    # Yes, then replace it with an underscore (and do external redirect)
    RewriteRule ^.*$ %1_%2 [R=301,L]

    # To map requested (UTF-8 encoded) URLs to local file system
    # (which cygwin apache seems to treat as latin-1-encoded...) --
    # not pretty but it sort of works.
    RewriteRule (.*?)Ã¥(.*) /$1å$2
    RewriteRule (.*?)Ã¤(.*) /$1ä$2
    RewriteRule (.*?)Ã¶(.*) /$1ö$2

    # DV
    RewriteRule ^dom/([0-9]*/[0-9]*)   /dom/${old_dv:$1}           [R=301,L]
    RewriteRule ^dom/index$            /dom/index/        [R=301,L]
    RewriteRule ^dom/index/(.*)        /dv/generated/index/$1      [L]
    RewriteRule ^dom/(.*)    	       /dv/generated/${dv:$1}.html [L]

    # SFS 
    RewriteRule ^(\d+):(.*).xht2$  /sfs/parsed/$1/$2.xht2      [L]
    RewriteRule ^(\d+):(.*).txt$   /sfs/intermediate/$1/$2.txt [L]
    RewriteRule ^(\d+):(.+)$       /sfs/generated/$1/$2.html   [L]
    RewriteRule ^index$            /index/       [R=301,L]
    RewriteRule ^index/(.*)$       /sfs/generated/index/$1     [L]
    
    # final rule - everything that hasn't matched so far (my attempts
    # to do a more general rule gave an infinite rewriting loop)
    RewriteRule   ^$             /site/generated/           [L]
    # RewriteRule   ^css/(.*)$     /site/generated/css/$1     [L]
    # RewriteRule   ^img/(.*)$     /site/generated/img/$1     [L]
    # RewriteRule   ^js/(.*)$      /site/generated/js/$1      [L]
    RewriteRule   ^om/(.*)$      /site/generated/om/$1      [L]
    RewriteRule   ^nyheter/(.*)$ /site/generated/nyheter/$1 [L]

    
    AddType application/rss+xml .rss
</Directory>
